{% set dpdk_count = (physical | selectattr("profile", "equalto", "computeovsdpdk") | list | count) %}
{% set sriov_count = ((physical | selectattr("profile", "equalto", "computesriov") | list | count) + (physical | selectattr("profile", "equalto", "computeovshwoffload") | list | count)) %}

resource_registry:
{% for ocrole in overcloud_roles %}
  OS::TripleO::{{ ocrole.name }}::Net::SoftwareConfig: /home/stack/templates/nic-configs/{{ ocrole.nic_configs }}
{% endfor %}

parameter_defaults:
  NetworkDeploymentActions: ['CREATE','UPDATE']
  DnsServers: {{ dns_servers | join(',') }}
  NtpServer: {{ ntp_servers | join(',') }}
  
  NeutronBridgeMappings: "{{ BridgeMappings }}"
  NeutronPhysicalBridge: "br-ex"
  NeutronFlatNetworks: "*"
  
  NeutronNetworkVLANRanges: "{{ NetworkVlanRanges }}"
  NeutronTunnelTypes: 'geneve'
  NeutronNetworkType: 'geneve,vlan'
  
  NovaSchedulerDefaultFilters:
    - AvailabilityZoneFilter
    - ComputeFilter
    - ComputeCapabilitiesFilter
    - ImagePropertiesFilter
    - ServerGroupAntiAffinityFilter
    - ServerGroupAffinityFilter
    - AggregateInstanceExtraSpecsFilter
    - NUMATopologyFilter
    - PciPassthroughFilter

{% if dpdk_count > 0 %}
  ComputeOvsDpdkParameters:
    KernelArgs: "default_hugepagesz={{ ComputeOvsDpdkProperties.hugepagesz }} hugepagesz={{ ComputeOvsDpdkProperties.hugepagesz }} hugepages={{ ComputeOvsDpdkProperties.hugepages }} {{ ComputeOvsDpdkProperties.kernelargs }} isolcpus={{ ComputeOvsDpdkProperties.isolcpus }}"
    TunedProfileName: "cpu-partitioning"
    IsolCpusList: "{{ ComputeOvsDpdkProperties.isolcpus }}"
    NovaComputeCpuDedicatedSet: "{{ ComputeOvsDpdkProperties.dedicatedcpus }}"
    NovaReservedHostMemory: {{ ComputeOvsDpdkProperties.hostmemory }}
    OvsDpdkSocketMemory: "{{ ComputeOvsDpdkProperties.socketmemory }}"
    OvsDpdkMemoryChannels: "{{ ComputeOvsDpdkProperties.memorychannels }}"
    OvsDpdkCoreList: "{{ ComputeOvsDpdkProperties.ovsdpdkcorelist }}"
    NovaComputeCpuSharedSet: "{{ ComputeOvsDpdkProperties.sharedcpus }}"
    OvsPmdCoreList: "{{ ComputeOvsDpdkProperties.ovspmdcorelist}}"
    OvsEnableDpdk: true
{% endif %}

{% if sriov_count > 0 %}
  ComputeSriovParameters:
    IsolCpusList: '{{ ComputeSriovProperties.isolcpus }}'
    KernelArgs: "default_hugepagesz={{ ComputeSriovProperties.hugepagesz }} hugepagesz={{ ComputeSriovProperties.hugepagesz }} hugepages={{ ComputeSriovProperties.hugepages }} {{ ComputeSriovProperties.kernelargs }} isolcpus={{ ComputeSriovProperties.isolcpus }}"
    TunedProfileName: "cpu-partitioning"
    NovaComputeCpuDedicatedSet: "{{ ComputeSriovProperties.dedicatedcpus }}"
    NovaComputeCpuSharedSet: "{{ ComputeSriovProperties.sharedcpus }}"
    NovaReservedHostMemory: {{ ComputeSriovProperties.hostmemory }}
    
    NovaPCIPassthrough:
{% for passt in ComputeSriovProperties.pcipassthrough %}
      - vendor_id: "{{ passt.vendor_id }}"
        product_id: "{{ passt.product_id }}"
        address: {{ passt.address }}
        physical_network: "{{ passt.network }}"
{% endfor %}
    NeutronPhysicalDevMappings: "{{ ComputeSriovProperties.physicaldevmappings }}"
  
  ComputeOvsHwOffloadParameters:
    IsolCpusList: '{{ ComputeOvsHwOffloadProperties.isolcpus }}'
    KernelArgs: "default_hugepagesz={{ ComputeOvsHwOffloadProperties.hugepagesz }} hugepagesz={{ ComputeOvsHwOffloadProperties.hugepagesz }} hugepages={{ ComputeOvsHwOffloadProperties.hugepages }} {{ ComputeOvsHwOffloadProperties.kernelargs }} isolcpus={{ ComputeOvsHwOffloadProperties.isolcpus }}"
    OvsHwOffload: true
    TunedProfileName: "cpu-partitioning"
    NovaComputeCpuDedicatedSet: "{{ ComputeOvsHwOffloadProperties.dedicatedcpus }}"
    NovaComputeCpuSharedSet: "{{ ComputeOvsHwOffloadProperties.sharedcpus }}"
    NovaReservedHostMemory: {{ ComputeOvsHwOffloadProperties.hostmemory }}
    
    NovaPCIPassthrough:
{% for passt in ComputeOvsHwOffloadProperties.pcipassthrough %}
      - vendor_id: "{{ passt.vendor_id }}"
        product_id: "{{ passt.product_id }}"
        address: {{ passt.address }}
        physical_network: "{{ passt.network }}"
{% endfor %}
    NeutronPhysicalDevMappings: "{{ ComputeOvsHwOffloadProperties.physicaldevmappings }}"
{% endif %}
