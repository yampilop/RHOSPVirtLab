- name: NETWORK - Stop and disable NetworkManager
  service:
    name: NetworkManager
    state: stopped
    enabled: false

- name: NETWORK - Set appropriate content in ifcfg-eth1 file
  copy:
    content: |
      BOOTPROTO=dhcp
      DEVICE=eth1
      ONBOOT=yes
      STARTMODE=auto
      TYPE=Ethernet
    dest: /etc/sysconfig/network-scripts/ifcfg-eth1
  notify: Restart network service

- name: NETWORK - Set appropriate content in ifcfg-eth0 file
  copy:
    content: |
      # This file is autogenerated by os-net-config
      DEVICE=eth0
      ONBOOT=yes
      HOTPLUG=no
      NM_CONTROLLED=no
      PEERDNS=no
      DEVICETYPE=ovs
      TYPE=OVSPort
      OVS_BRIDGE=br-ctlplane
      BOOTPROTO=none
      MTU=1500
    dest: /etc/sysconfig/network-scripts/ifcfg-eth0
  notify: Restart network service

- name: NETWORK - Set appropriate content in ifcfg-br-ctlplane file
  copy:
    content: |
      # This file is autogenerated by os-net-config
      DEVICE=br-ctlplane
      ONBOOT=yes
      HOTPLUG=no
      NM_CONTROLLED=no
      PEERDNS=no
      DEVICETYPE=ovs
      TYPE=OVSBridge
      BOOTPROTO=static
      IPADDR=192.168.24.1
      NETMASK=255.255.255.0
      OVS_EXTRA="set bridge br-ctlplane other-config:hwaddr=0c:1f:0d:11:ba:00 -- br-set-external-id br-ctlplane bridge-id br-ctlplane -- set bridge br-ctlplane fail_mode=standalone -- del-controller br-ctlplane -- set bridge br-ctlplane fail_mode=standalone -- del-controller br-ctlplane  -- add-port br-ctlplane vlan10 tag=10 -- set interface vlan10 type=internal"
    dest: /etc/sysconfig/network-scripts/ifcfg-br-ctlplane
  notify: Restart network service

- name: NETWORK - Set appropriate content in ifcfg-vlan10 file
  copy:
    content: |
      BOOTPROTO=none
      IPADDR=10.0.0.1
      PREFIX=24
      DEFROUTE=no
      IPV4_FAILURE_FATAL=no
      IPV6INIT=yes
      IPV6_AUTOCONF=no
      IPV6ADDR=2001:db8:fd00:1000::/64
      IPV6_DEFROUTE=no
      IPV6_FAILURE_FATAL=no
      IPV6_ADDR_GEN_MODE=stable-privacy
      NAME=vlan10
      DEVICE=vlan10
      ONBOOT=yes
      NM_CONTROLLED=no
    dest: /etc/sysconfig/network-scripts/ifcfg-vlan10
  notify: Restart network service

- name: NETWORK - Enable and restart network.service
  service:
    name: network
    state: started
    enabled: true

- name: NETWORK - Masquerade external network traffic
  iptables:
    table: nat
    chain: POSTROUTING
    jump: MASQUERADE
    source: 10.0.0.0/24
    ctstate: NEW,ESTABLISHED,RELATED
    comment: CUSTOM masquerade external network traffic
